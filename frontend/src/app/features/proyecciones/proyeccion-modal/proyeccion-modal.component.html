<p-dialog
  [header]="proyeccionToEdit ? 'Editar Proyección' : 'Nueva Proyección'"
  [(visible)]="visible"
  [modal]="true"
  [style]="{ width: '450px' }"
  styleClass="p-fluid"
  [appendTo]="'body'"
  [dismissableMask]="true"
>
  <ng-template #content>
    <form [formGroup]="form" class="flex flex-column gap-4">
      <!-- Tipo -->
      <div class="field">
        <label for="tipo" class="font-bold">Tipo</label>
        <p-select
          id="tipo"
          [options]="tipos"
          formControlName="tipo"
          optionLabel="label"
          optionValue="value"
        ></p-select>
      </div>

      <!-- Categoría (click to open modal) -->
      <div class="field">
        <label for="categoria" class="font-bold">Categoría</label>
        <button
          type="button"
          pButton
          class="p-button-outlined w-full text-left justify-content-start"
          [class.p-button-success]="form.get('tipo')?.value === 'INGRESO'"
          [class.p-button-warning]="form.get('tipo')?.value === 'EGRESO'"
          (click)="abrirSelectorCategoria()"
        >
          @if (selectedCategory()) {
            <span class="mr-2">{{ selectedCategory()?.icono }}</span>
            <span>{{ selectedCategory()?.nombre }}</span>
          } @else {
            <i class="pi pi-folder-open mr-2"></i>
            <span class="text-500">Seleccionar categoría...</span>
          }
        </button>
        @if (form.get('categoriaId')?.invalid && form.get('categoriaId')?.touched) {
          <small class="p-error block">Categoría requerida</small>
        }
      </div>

      <!-- Monto -->
      <div class="field">
        <label for="monto" class="font-bold">Monto</label>
        <p-inputNumber
          id="monto"
          formControlName="monto"
          mode="currency"
          currency="COP"
          locale="es-CO"
          placeholder="$ 0"
          [min]="0"
          [allowEmpty]="true"
        ></p-inputNumber>
        @if (form.get('monto')?.invalid && form.get('monto')?.touched) {
          <small class="p-error block">Monto requerido</small>
        }
      </div>

      <!-- Frecuencia -->
      <div class="field">
        <label for="frecuencia" class="font-bold">Frecuencia</label>
        <p-select
          id="frecuencia"
          [options]="frecuencias"
          formControlName="frecuencia"
          optionLabel="label"
          optionValue="value"
        ></p-select>
      </div>

      <!-- Fecha Inicio -->
      <div class="field">
        <label for="fechaInicio" class="font-bold">Fecha Inicio</label>
        <p-datePicker
          id="fechaInicio"
          formControlName="fechaInicio"
          dateFormat="dd/mm/yy"
          [showIcon]="true"
          appendTo="body"
        ></p-datePicker>
      </div>
    </form>
  </ng-template>

  <ng-template #footer>
    <button
      pButton
      label="Cancelar"
      icon="pi pi-times"
      class="p-button-text"
      (click)="cerrar()"
    ></button>
    <button
      pButton
      label="Guardar"
      icon="pi pi-check"
      class="p-button-primary"
      [loading]="loading()"
      [disabled]="form.invalid"
      (click)="guardar()"
    ></button>
  </ng-template>
</p-dialog>

<!-- Category Selector Modal -->
<app-category-selector-modal
  [(visible)]="categorySelectorVisible"
  [type]="form.get('tipo')?.value"
  (onSelect)="onCategoriaSeleccionada($event)"
></app-category-selector-modal>
