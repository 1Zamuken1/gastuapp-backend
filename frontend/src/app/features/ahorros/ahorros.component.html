<!--
  AhorrosComponent - Vista Principal (Replica Egresos)
-->
<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="ahorros-page">
  <!-- ==================== HEADER ==================== -->
  <div class="page-header">
    <div class="header-left">
      <h1 class="page-title flex align-items-center gap-2">
        <i class="pi pi-briefcase savings-icon"></i>
        <span>Mis Ahorros</span>
      </h1>
      <p class="page-subtitle">Gestiona tus metas de ahorro</p>
    </div>

    <div class="header-right">
      <!-- Total General -->
      <div class="total-card">
        <span class="total-label">Total Ahorrado</span>
        <span class="total-value amount-positive">
          {{ formatCurrency(totalAhorrado()) }}
        </span>
      </div>

      <button
        pButton
        type="button"
        label="Nueva Meta"
        icon="pi pi-plus"
        class="p-button-primary"
        (click)="openCrearMeta()"
      ></button>
    </div>
  </div>

  <!-- ==================== TOOLBAR ==================== -->
  <div class="toolbar wrapper mb-4">
    <div class="flex flex-wrap gap-3 align-items-center justify-content-between">
      <!-- BÃºsqueda -->
      <p-iconfield class="flex-grow-1" style="max-width: 300px">
        <p-inputicon styleClass="pi pi-search"></p-inputicon>
        <input
          pInputText
          type="text"
          placeholder="Buscar meta..."
          [ngModel]="searchTerm()"
          (ngModelChange)="onSearchChange($event)"
          class="w-full"
        />
      </p-iconfield>

      <!-- Ordenamiento & Exportar -->
      <div class="flex align-items-center gap-2">
        <span class="text-sm text-500">Ordenar:</span>
        <p-select
          [options]="sortOptions"
          [ngModel]="sortOption()"
          (ngModelChange)="onSortChange($event)"
          optionLabel="label"
          optionValue="value"
          [style]="{ minWidth: '180px' }"
          appendTo="body"
        ></p-select>

        <button
          pButton
          type="button"
          icon="pi pi-download"
          label="Exportar"
          class="p-button-outlined"
          (click)="openExport()"
          pTooltip="Exportar reporte"
          tooltipPosition="bottom"
        ></button>
      </div>
    </div>
  </div>

  <!-- ==================== CARDS CONTAINER ==================== -->
  <div class="card-calm">
    @if (loading()) {
      <div class="skeleton-grid">
        <p-skeleton width="100%" height="8rem" styleClass="mb-2"></p-skeleton>
        <p-skeleton width="100%" height="8rem" styleClass="mb-2"></p-skeleton>
      </div>
    } @else if (metasFiltradas().length === 0) {
      <div class="empty-state">
        <i class="pi pi-wallet empty-icon"></i>
        <h3>No hay metas de ahorro</h3>
        <p>Crea tu primera meta para comenzar a ahorrar</p>
        <button
          pButton
          label="Crear mi primera meta"
          icon="pi pi-plus"
          class="p-button-primary"
          (click)="openCrearMeta()"
        ></button>
      </div>
    } @else {
      <div class="grid">
        @for (meta of metasFiltradas(); track meta.id) {
          <div class="col-12 md:col-6 lg:col-4" (click)="verDetalle(meta)">
            <div class="category-card cursor-pointer">
              <!-- Card Content -->
              <div
                class="card-content flex flex-column gap-3 p-4 border-1 surface-border border-round transition-all shadow-2 h-full"
              >
                <div class="flex justify-content-between align-items-start">
                  <div class="flex align-items-center gap-3">
                    <div class="icon-wrapper" [style.background]="(meta.color || '#f59e0b') + '20'">
                      <i
                        [class]="meta.icono || 'pi pi-wallet'"
                        class="text-2xl"
                        [style.color]="meta.color || '#f59e0b'"
                      ></i>
                    </div>
                    <div>
                      <span class="text-xl font-semibold text-900">{{ meta.nombre }}</span>
                      <span class="text-sm text-500 block"
                        >Vence:
                        {{
                          meta.fechaLimite ? (meta.fechaLimite | date: 'dd/MM/yyyy') : 'Sin fecha'
                        }}</span
                      >
                    </div>
                  </div>
                  <p-tag
                    [value]="meta.estado"
                    [severity]="getSeverity(meta.estado)"
                    styleClass="text-xs"
                  ></p-tag>
                </div>

                <div class="mt-auto">
                  <div class="flex justify-content-between mb-1">
                    <span class="text-sm text-500">Ahorrado</span>
                    <span class="text-sm text-500">Objetivo</span>
                  </div>
                  <div class="flex justify-content-between mb-2">
                    <span class="text-2xl font-bold amount-positive">{{
                      formatCurrency(meta.montoActual)
                    }}</span>
                    <span class="text-lg font-semibold text-900">{{
                      formatCurrency(meta.montoObjetivo)
                    }}</span>
                  </div>

                  <p-progressBar
                    [value]="meta.porcentajeProgreso"
                    [showValue]="false"
                    styleClass="h-1rem"
                  ></p-progressBar>
                  <div class="text-right mt-1">
                    <span class="text-xs text-500"
                      >{{ meta.porcentajeProgreso | number: '1.0-1' }}% completado</span
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
        }
      </div>
    }
  </div>
</div>

<!-- MODALES -->
<app-crear-meta-modal
  [(visible)]="mostrarModalCrear"
  [metaToEdit]="metaToEdit"
  (metaCreated)="onMetaCreated()"
  (metaUpdated)="onMetaCreated()"
></app-crear-meta-modal>

<app-detalle-meta-modal
  [(visible)]="mostrarModalDetalle"
  [meta]="metaSeleccionada"
  (abonoRegistrado)="onAbonoRegistrado()"
  (abonoDeleted)="onAbonoRegistrado()"
  (metaDeleted)="onMetaDeleted()"
  (metaEditRequested)="onMetaEditRequested($event)"
></app-detalle-meta-modal>
