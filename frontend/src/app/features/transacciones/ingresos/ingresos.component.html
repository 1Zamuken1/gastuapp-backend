<!--
  IngresosComponent - Vista por Categorías (Modal Detalle)
-->
<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="ingresos-page">
  <!-- ==================== HEADER ==================== -->
  <div class="page-header">
    <div class="header-left">
      <h1 class="page-title flex align-items-center gap-2">
        <i class="pi pi-arrow-circle-up income-icon"></i>
        <span>Ingresos</span>
      </h1>
      <p class="page-subtitle">Gestiona tus fuentes de ingreso por categoría</p>
    </div>

    <div class="header-right">
      <!-- Total General -->
      <div class="total-card">
        <span class="total-label">Total Recaudo</span>
        <span class="total-value amount-positive">
          {{ formatCurrency(totalIngresos()) }}
        </span>
      </div>

      <button
        pButton
        type="button"
        label="Nuevo Ingreso"
        icon="pi pi-plus"
        class="p-button-success"
        (click)="nuevoIngreso()"
      ></button>
    </div>
  </div>

  <!-- ==================== TOOLBAR: BÚSQUEDA Y ORDENAMIENTO ==================== -->
  <div class="toolbar-wrapper mb-4">
    <div class="flex flex-wrap gap-3 align-items-center justify-content-between">
      <!-- Búsqueda con ícono a la izquierda -->
      <p-iconfield class="flex-grow-1" style="max-width: 300px">
        <p-inputicon styleClass="pi pi-search"></p-inputicon>
        <input
          pInputText
          type="text"
          placeholder="Buscar categoría o descripción..."
          [ngModel]="searchTerm()"
          (ngModelChange)="onSearchChange($event)"
          class="w-full"
        />
      </p-iconfield>

      <!-- Ordenamiento y Exportación -->
      <div class="flex align-items-center gap-2">
        <span class="text-sm text-500">Ordenar:</span>
        <p-select
          [options]="sortOptions"
          [ngModel]="sortOption()"
          (ngModelChange)="onSortChange({ value: $event })"
          optionLabel="label"
          optionValue="value"
          placeholder="Seleccionar orden"
          [style]="{ minWidth: '180px' }"
          appendTo="body"
        ></p-select>

        <button
          pButton
          type="button"
          icon="pi pi-download"
          label="Exportar"
          class="p-button-outlined"
          (click)="openExport()"
          pTooltip="Exportar reporte"
          tooltipPosition="bottom"
        ></button>
      </div>
    </div>
  </div>

  <!-- ==================== VISTA: CATEGORÍAS (CARDS) ==================== -->
  <div class="card-calm">
    @if (loading()) {
      <div class="skeleton-grid">
        <p-skeleton width="100%" height="8rem" styleClass="mb-2"></p-skeleton>
        <p-skeleton width="100%" height="8rem" styleClass="mb-2"></p-skeleton>
      </div>
    } @else if (categoriasFiltradas.length === 0) {
      <div class="empty-state">
        <i class="pi pi-inbox empty-icon"></i>
        <h3>No hay ingresos registrados</h3>
        <p>Crea tu primer ingreso para ver las categorías</p>
      </div>
    } @else {
      <div class="grid">
        @for (cat of categoriasFiltradas; track cat.id) {
          <div class="col-12 md:col-6 lg:col-4" (click)="verDetalleCategoria(cat)">
            <div class="category-card cursor-pointer">
              <!-- Card Content -->
              <div
                class="card-content flex flex-column gap-3 p-4 border-1 surface-border border-round transition-all shadow-2 h-full"
              >
                <div class="flex justify-content-between align-items-start">
                  <div class="flex align-items-center gap-3">
                    <span class="text-3xl">{{ cat.icono }}</span>
                    <span class="text-xl font-semibold text-900">{{ cat.nombre }}</span>
                  </div>
                  <div class="badge-income">{{ cat.cantidad }} reg.</div>
                </div>

                <div class="mt-auto">
                  <span class="text-sm text-500 block mb-1">Total Recaudado</span>
                  <span class="text-2xl font-bold amount-positive">{{
                    formatCurrency(cat.total)
                  }}</span>
                </div>
              </div>
            </div>
          </div>
        }
      </div>
    }
  </div>

  <!-- ==================== DIALOGO DETALLE (TABLA) ==================== -->
  <p-dialog
    [(visible)]="mostrarDetalleDialog"
    [header]="selectedCategory()?.nombre || 'Detalle'"
    [modal]="true"
    [style]="{ width: '800px', maxWidth: '95vw' }"
    [draggable]="false"
    [resizable]="false"
    [dismissableMask]="true"
    [blockScroll]="true"
  >
    <ng-template pTemplate="header">
      <div class="flex align-items-center gap-2">
        <span class="text-xl font-bold">{{ selectedCategory()?.nombre }}</span>
        <span class="badge-income ml-2">{{ selectedCategory()?.cantidad }} registros</span>
      </div>
      <div class="flex-grow-1"></div>
      <!-- Botón Especial Contextual -->
      <button
        pButton
        label="Nuevo en esta categoría"
        icon="pi pi-plus"
        class="p-button-sm p-button-outlined p-button-success mr-4"
        (click)="nuevoIngreso()"
      ></button>
    </ng-template>

    <div class="mt-3">
      <!-- Tabla Detalle -->
      <p-table
        [value]="selectedCategory()?.transacciones || []"
        [paginator]="true"
        [rows]="5"
        [rowsPerPageOptions]="[5, 10]"
        sortField="fecha"
        [sortOrder]="-1"
        styleClass="p-datatable-sm p-datatable-striped"
        paginatorDropdownAppendTo="body"
      >
        <ng-template #header>
          <tr>
            <th pSortableColumn="fecha">Fecha <p-sortIcon field="fecha"></p-sortIcon></th>
            <th pSortableColumn="descripcion">
              Descripción <p-sortIcon field="descripcion"></p-sortIcon>
            </th>
            <th pSortableColumn="monto" class="text-right">
              Monto <p-sortIcon field="monto"></p-sortIcon>
            </th>
            <th class="text-center">Acciones</th>
          </tr>
        </ng-template>

        <ng-template #body let-ingreso>
          <tr>
            <td>{{ formatDate(ingreso.fecha) }}</td>
            <td>{{ ingreso.descripcion }}</td>
            <td class="text-right amount-positive font-semibold">
              {{ formatCurrency(ingreso.monto) }}
            </td>
            <td class="text-center">
              <button
                pButton
                icon="pi pi-pencil"
                class="p-button-text p-button-sm"
                (click)="editarIngreso(ingreso)"
              ></button>
              <button
                pButton
                icon="pi pi-trash"
                class="p-button-text p-button-danger p-button-sm"
                (click)="confirmarEliminar(ingreso)"
              ></button>
            </td>
          </tr>
        </ng-template>

        <ng-template #summary>
          <div class="flex justify-content-end subtotal-summary">
            <span class="font-bold mr-2">Total Categoría:</span>
            <span class="amount-positive font-bold">{{
              formatCurrency(selectedCategory()?.total || 0)
            }}</span>
          </div>
        </ng-template>
      </p-table>
    </div>
  </p-dialog>

  <!-- ==================== DIALOGO CREACIÓN/EDICIÓN ==================== -->
  <p-dialog
    [(visible)]="mostrarDialog"
    [header]="esEdicion() ? 'Editar Ingreso' : 'Nuevo Ingreso'"
    [modal]="true"
    [style]="{ width: '450px' }"
    styleClass="p-fluid"
    [appendTo]="'body'"
    [dismissableMask]="true"
  >
    <!-- appendTo body es clave para que se muestre sobre el otro dialog -->
    <ng-template #content>
      <form [formGroup]="ingresoForm" class="flex flex-column gap-4">
        <!-- Monto -->
        <div class="field">
          <label for="monto" class="font-bold">Monto</label>
          <p-inputNumber
            id="monto"
            formControlName="monto"
            mode="currency"
            currency="COP"
            locale="es-CO"
            placeholder="$ 0"
            [min]="0"
            [allowEmpty]="true"
          ></p-inputNumber>
          @if (ingresoForm.get('monto')?.invalid && ingresoForm.get('monto')?.touched) {
            <small class="p-error block">Monto requerido</small>
          }
        </div>

        <!-- Descripción -->
        <div class="field">
          <label for="descripcion" class="font-bold">Descripción</label>
          <input
            pInputText
            id="descripcion"
            formControlName="descripcion"
            placeholder="Ej: Salario quincenal"
          />
          @if (ingresoForm.get('descripcion')?.invalid && ingresoForm.get('descripcion')?.touched) {
            <small class="p-error block">Descripción requerida</small>
          }
        </div>

        <!-- Fecha -->
        <div class="field">
          <label for="fecha" class="font-bold">Fecha</label>
          <p-datePicker
            id="fecha"
            formControlName="fecha"
            dateFormat="dd/mm/yy"
            [showIcon]="true"
            appendTo="body"
          ></p-datePicker>
        </div>

        <!-- Categoría (Selector Modal) -->
        <div class="field">
          <label class="font-bold">Categoría</label>
          <div class="p-inputgroup cursor-pointer" (click)="showCategorySelector.set(true)">
            <span class="p-inputgroup-addon">
              <i class="pi pi-arrow-circle-up text-green-500"></i>
            </span>
            <input
              pInputText
              readonly
              [value]="ingresoForm.get('categoria')?.value?.nombre || 'Seleccionar Categoría'"
              class="cursor-pointer"
              [class.text-500]="!ingresoForm.get('categoria')?.value"
            />
            <button pButton icon="pi pi-search" type="button" class="p-button-outlined"></button>
          </div>
          @if (ingresoForm.get('categoria')?.invalid && ingresoForm.get('categoria')?.touched) {
            <small class="p-error block">Categoría requerida</small>
          }
        </div>
      </form>
    </ng-template>

    <ng-template #footer>
      <button
        pButton
        label="Cancelar"
        icon="pi pi-times"
        class="p-button-text"
        (click)="mostrarDialog.set(false)"
      ></button>
      <button
        pButton
        label="Guardar"
        icon="pi pi-check"
        class="p-button-success"
        [loading]="saving()"
        (click)="guardarIngreso()"
      ></button>
    </ng-template>
  </p-dialog>

  <!-- MODAL DE EXPORTACIÓN -->
  @if (exportConfig()) {
    <app-export-modal [(visible)]="exportVisible" [config]="exportConfig()!"></app-export-modal>
  }

  <!-- MODAL SELECTOR CATEGORÍA -->
  <app-category-selector-modal
    [(visible)]="showCategorySelector"
    type="INGRESO"
    (onSelect)="onCategorySelected($event)"
  ></app-category-selector-modal>
</div>
